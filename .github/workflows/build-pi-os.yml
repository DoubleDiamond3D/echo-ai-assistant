name: Build Echo AI Assistant Pi OS Image

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Pi OS version to build'
        required: false
        default: '2024-12-05'

jobs:
  build-pi-os:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up environment
      run: |
        echo "IMAGE_NAME=echo-ai-assistant-$(date +%Y%m%d)" >> $GITHUB_ENV
        echo "PI_OS_VERSION=${GITHUB_EVENT.inputs.version:-2024-12-05}" >> $GITHUB_ENV
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget unzip qemu-user-static \
          parted kpartx dosfstools e2fsprogs \
          xz-utils curl
        
    - name: Build Pi OS image
      run: |
        chmod +x scripts/build_pi_os.sh
        ./scripts/build_pi_os.sh
        
    - name: Upload Pi OS image
      uses: actions/upload-artifact@v4
      with:
        name: echo-pi-os-image
        path: |
          /tmp/echo-pi-os/echo-ai-assistant-*.img.xz
          /tmp/echo-pi-os/echo-ai-assistant-*.img.xz.sha256
          /tmp/echo-pi-os/echo-ai-assistant-*.img.xz.md5
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          /tmp/echo-pi-os/echo-ai-assistant-*.img.xz
          /tmp/echo-pi-os/echo-ai-assistant-*.img.xz.sha256
          /tmp/echo-pi-os/echo-ai-assistant-*.img.xz.md5
        body: |
          # Echo AI Assistant Pi OS Image
          
          This is a custom Raspberry Pi OS image with Echo AI Assistant pre-installed.
          
          ## ğŸš€ Quick Start
          
          1. Download the image file
          2. Use Raspberry Pi Imager to flash it to your SD card
          3. Boot your Raspberry Pi
          4. Access the web interface at `http://[PI_IP]:5000`
          5. Use API token: `echo-dev-kit-2025`
          
          ## ğŸ“‹ What's Included
          
          - âœ… Echo AI Assistant pre-installed
          - âœ… Ollama with Qwen2.5 model
          - âœ… All dependencies installed
          - âœ… Services configured and enabled
          - âœ… WiFi setup ready
          - âœ… SSH enabled
          - âœ… Camera and audio configured
          
          ## ğŸ”§ Configuration
          
          After first boot, you can configure Echo through the web interface or by editing `/opt/echo-ai/.env`.
          
          ## ğŸ“š Documentation
          
          Full documentation is available at: https://github.com/${{ github.repository }}
          
          ## ğŸ” Security
          
          **Important**: Change the default API token after first boot!
          
          The default API token is `echo-dev-kit-2025`. Please change this in the web interface or by editing the `.env` file.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
